<!DOCTYPE html>
<html>

<head>
	<title>Weather Complete</title>
	<meta charset="UTF-8" />
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
	<div id='main-container'>
		<div id='weather-container'>
			<h4 id="date"></h4>
			<h2 id="weather-for-city"></h2>
			<br>
			<div class ="whole">
				<div class="current">
					<h3 id="weather-condition"></h3>
					<h1 id="current-temp"></h1>
					<h4 id="aqi"></h4>
				</div>
				<img src="" class="condition-picture">
			</div>
			<br>
			<br>
			<div id="forecast-container">
			</div>
		</div> 
	</div>
	<div id='side-container'>
		<div>
			<input id='search-input' placeholder='search for a city'></input>
			<button id='search-button' onclick="search()">search</button>
		</div>
		<ul id='search-results-list'></ul>
	</div>
</body>

<script>
		// USE YOUR OWN API KEY
		const apiKey = "f5a4ed1f797a72dc41c1c40b0bcef3a7";

        // variable that stores the city that is chosen
		let city;
        // variable that stores the weather and forecast for the city
		let weather;
        // the variable that stores the air quality index for the city
		let aqi;

		// function that accepts that a number N and returns the name of the day and the date N days from now as a string
		function formatDate(daysFromNow = 0) {
			let output = ''
			var date = new Date();
			date.setDate(date.getDate() + daysFromNow);
			output += date.toLocaleString('en-US', { weekday: 'long' }).toUpperCase()
			output += ' ' + date.getDate()
			return output
		}

		// function that uses OpenWeatherMap's geocoding API to find locations
		function search() {
			// takes the value from the search input
			let searchInput = document.querySelector("#search-input").value;
			if (searchInput) {
				// creates the API call with the value from the search input as a query
				let apiCall = `https://api.openweathermap.org/geo/1.0/direct?q=${searchInput},,US&limit=5&appid=${apiKey}`;
				// calls the API
				fetch(apiCall)
					.then((response) => 
						// after recieving a response, take the response from the server and convert it to JSON 
						response.json()
					)
					.then((data) => {
						// after recieving the converted JSON data, pass the JSON to the renderSearchResults() function
						renderSearchResults(data)
					});
			}
		}

		// function that renders the search results as an unordered list
		function renderSearchResults(searchResults) {
				// selects the unordered list element search-results-list
				const ul = document.querySelector('#search-results-list')
				// shows the unordered list if was hidden previously
				ul.classList.remove("hidden");
				// clears out any list items from the previous search
				ul.innerHTML = ''
				// loops through each search result and creates and attaches a list item for the unordered list
				searchResults.forEach((searchResult, index) => {
					// creates a new unordered list element
					const li = document.createElement('li')
					// sets the list item's class as search-result
					li.setAttribute('class', 'search-result')
					// sets the text inside the list item as the name and state of the city 
					const fullName = searchResult.name + ', ' + searchResult.state
					li.innerHTML = fullName
					// if the list item of a city is clicked, call the selectCity() function
					li.addEventListener('click', () => selectCity(fullName, searchResult.name, searchResult.state, searchResult.lat, searchResult.lon))
					// attaches the list item elements to search-results-list
					ul.appendChild(li)
			})	
		}

		// function that is called whenever a city has been selected
		// HINT: think about what should be rendering on the screen whenever a city is selected and what information is needed to make that happen 
		async function selectCity(fullName, name, state, lat, lon) {
			const forecast = document.querySelector("#forecast-container")
			forecast.innerHTML = ""
			// hides the search-results-list since it is not needed right now
			document.querySelector('#search-results-list').className = 'hidden'
			// sets the global city variable
			document.querySelector("#search-input").value = ''
			city = {
				fullName: fullName,
				name: name,
				state: state,
				lat: lat,
				lon: lon
			}
			//printing the city object to the console
			console.log(city);
            // BEGIN CODING HERE
			//generate today's date
			document.querySelector('#date').innerText = formatDate()
			document.querySelector('#weather-for-city').innerText = "Weather for " + city.name + ", " + city.state
			//call api for today's weather and get data
			let todaysWeatherApiCall = `https://api.openweathermap.org/data/2.5/weather?lat=${city.lat}&lon=${city.lon}&units=imperial&appid=${apiKey}`
			let todayResponse = await fetch(todaysWeatherApiCall)
			let todayData = await todayResponse.json()
			//call api for 5 day forecast data
			let weatherApiCall = `http://api.openweathermap.org/data/2.5/forecast?lat=${city.lat}&lon=${city.lon}&units=imperial&appid=${apiKey}`
			let weatherResponse = await fetch(weatherApiCall);
			let weatherData = await weatherResponse.json();
			const jsonString = JSON.stringify(weatherData)
			const jsonObject = JSON.parse(jsonString)
			//grab only the list that contains the 5 day forecast split into 3 hour increments
			listOnly = jsonObject.list
			//create array that stores min and max temps for each day
			const dailyTemps = []
			for (let day = 0; day < 5; day++) {
				const dayData = listOnly.slice(day * 8, (day*8 + 8))
				console.log(dayData)
				const temps = dayData.map(item => item.main.temp)
				const minTemp = Math.min(...temps)
				const maxTemp = Math.max(...temps)
				dailyTemps.push({minTemp, maxTemp})
			}
			//create separate array for the weather conditions for the next 5 days
			const weatherCondition = []
			//recorded conditions are at 12pm (12/3=4 so start at 4)
			for (let i = 4; i < listOnly.length; i+=8) {
				weatherCondition.push(listOnly[i].weather[0].main)
			}
			//display today's weather
			document.querySelector('#weather-condition').innerText = todayData.weather[0].main
			document.querySelector('#current-temp').innerText = Math.round(todayData.main.temp) + "°"
			document.querySelector('.condition-picture').src = conditionImage(todayData.weather[0].main)
			//call api for AQI and display
			let aqiApiCall = `http://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`
			let aqiResponse = await fetch(aqiApiCall)
			let aqiData = await aqiResponse.json()
			document.querySelector('#aqi').innerText = "AQI: " + aqiData.list[0].main.aqi
			//create image for forecasts
			for (let i = 0; i < 5; i++)
			{
				const box = document.createElement("div")
				box.style.background = "white";
				box.style.width = "80%";
				box.style.height = "100%";
				box.style.margin = "2%"
				box.style.padding = "2%"
				box.style.display = "flex";
				box.style.flexDirection = "column";
				box.style.justifyContent = "center"
				box.innerHTML = `
					<div>
						<h2>${formatDate(i+1)}</h2>
					</div>
						<img src="${conditionImage(weatherCondition[i])}">
					<div>
					<div>
				    	<h1>${Math.round(dailyTemps[i].maxTemp) + "° to " + Math.round(dailyTemps[i].minTemp) + "°"}</h1>
				 	</div>	
				`
				const title = box.querySelector("h2")
				title.style.textAlign = "center"
				title.style.fontSize = ".7rem"
				title.style.margin = "5%"
				const temps = box.querySelector("h1")
				temps.style.textAlign = "center"
				temps.style.fontSize = "1rem"
				temps.style.margin = "5%"
				forecast.appendChild(box)
			}

		}

		//returns image for corresponding weather condition
		function conditionImage(weatherCondition)
		{
			if (weatherCondition == "Clear"){
				return "./icons/01d.svg"
			}
			else if (weatherCondition == "Clouds"){
				return "./icons/03d.svg"
			}
			else if (weatherCondition == "Rain"){
				return "./icons/09d.svg"
			}
		}
	</script>
</html>